## 数据库编程

### 数据库API(DB API)
	全局变量
		3个全局变量：
			1. apilevel ： 显示数据库模块的API版本号
			2. threadsafety ： 指定数据库模块的线程安全等级，等级值为 0～3，3代表模块完全是线程安全的，1:部分安全 ，0：  完全不能共享该模块
			3. paramstyle ： 指定SQL语句需要参数时，使用风格的参数，返回如下变量值：
				format ： 格式化字符串代表参数，使用 %s
				pyformat ： 使用扩展的格式代码代表参数
				qmark ： 使用 ？ 问号代表参数
				numeric ： 使用数字占位符 :N 代表参数，1 代表一个参数，2 也代表参数
				named ： 使用命名占位符 :name 代表参数

	数据库API的核心类
		连接对象的方法和属性
			cursor() ：			打开游标
			commit() ：			提交事物
			rollback()：		回滚事物
			close() ：			关闭数据库连接
			isolation_level:	返回或指定数据库连接中事物的隔离级别
			in_transaction:		判断当前是否处于事物中
	cursor ： 返回游标对象，游标对象是 Python DB API的核心对象，用于执行各种SQL语句，包括DDL、DML、select 查询语句等，使用游标执行不同的SQL语句返回不同的数据。
		游标对象的属性和方法：
			execute(sql[,parameters]) ： 执行SQL语句，parameters 参数用于为SQL语句中的参数指定值
			executemany(sql,seq_of_parameters) ：重复执行SQL语句，通过第二个参数指定值，序列有多少个元素，SQL语句被执行多少次
			executescript(sql_script) ：直接执行包含多条SQL语句的SQL脚本
			fetchone() : 获取查询结果集的下一行，如没有，则返回None
			fetchmany(size=cursor.arraysize) ：返回查询结果集的下N行组成的列表，如没有，返回空
			fetchall() : 返回查询结果集的全部行组成的列表
			close() : 关闭游标
			rowcount ： 只读属性返回受SQL语句影响的行数，修改的记录条数也可通过该属性获取
			lastrowid ：获取最后修改行的rowid
			arraysize ： 设置或获取fetchmany 默认获取的记录条数，默认为 1
			desciption ： 获取最后一次查询返回所有列的信息，只读
			connection ： 返回创建游标的数据库连接对象，属性只读

		操作数据库的基本流程
			1. 调用 connect 方法打开数据库连接，返回数据库连接对象
			2. 通过数据库连接对象打开游标
			3. 使用游标执行SQL语句 包括 DDL、DML、select查询语句，如执行的是查询语句，则处理查询数据
			4. 关闭游标
			5. 关闭数据库连接
			[图示](http://c.biancheng.net/uploads/allimg/190301/2-1Z301153400E3.gif)

	SQLite 创建数据库表
		是一种嵌入式数据库，数据库是一个文件，SQLite将整个数据库包括定义表、索引以及数据本身，作为一个单独的、可跨平台使用的文件存储在主机中。不需要安装。直接导入
		连接数据库：
			connect() 函数
				conn = sqlite3.connect('xx.db')		// xx.db 是一个数据库,如不存在，在当前目录下创建对应的文件
		创建数据库：
			import sqlite3
			conn = sqlite3.connect('xx.db ')
			c = conn.cursor()
			c.execute(''' create table user_tb(
				id interger primary key autoincrement,
				name text,
				pass text,
			gender text)'''
					)
			c.execute(''' create table post_tb
					id integer primary key autoincrement,
					post_name text,
					post_author text,
					post_number real,
					user_id integer,
					foreign key(user_id) references user_tb(id)''')
			c.close()
			conn.close()
		SQLite 支持 NULL、INTEGER、REAL浮点数、TEXT文本、BLOD大二进制对象
		
	SQLite execute 和 executemany 
		游标的execute 方法可执行DML 操纵语言 的 insert 、update、delete 语句，对数据库执行插入、修改和删除数据操作
		调用execute 方法执行insert 可向数据库插入数据
		向数据库插入一条数据：
			// 导入访问SQLite的模块
			import sqlite3
			// 打开或创建数据库， 可用 :memory: 代表创建内存中的数据库
			conn = sqlite3.connect('xx.db')			// xx.db 指创建时指定的数据库文件
			// 获取游标
			c = conn.cursor()
			//	调用执行 insert 语句插入数据
			c.execute('insert into user_tb values (null,?,?,?)', ('xxx','xxx','xxx'))
			c.execute('insert into xxx_tb values (null,?,?,?)' ('xx','xx','xx'))
			//	提交事物
			conn.commit()
			// 关闭游标
			c.close()
			// 关闭连接
			conn.close()
	 executemany ： 多次执行同一条SQl语句
			import sqlite3
			conn = sqlite3.connect('xx.db')
			c = conn.cursor()
			c.executemany('inert into xxx_tb values (null,?,?,?)',
				(	('xx','xxx','xxxx'),
					('aa','aaa','aaaa'),
					('bb','bbb','bbbb'),
					('zz','zzz','zzzz')
				))
			conn.commit()
			c.close()
			conn.close()
	update | delete
		import sqlite3
		conn = sqlite3.connect('xx.db')
		c = conn.cursor()
		c.execute(' update user_tb set xxx=? where xx=? ',
					(('aa',1),
					('bb',2)
				))
		print('change numbers : ', c.rowcount)
		conn.commit()
		c.close()
		conn.close()
	
	SQLite : fetchone() , fetchmany() and fetchall:
		select 语句执行查询结果， 通过游标的 fetchone 、fetchmany、fecthall获取查询结果，fetchone 获取一条，fetchmany 获取多条， fetchall 获取全部
		import sqlite3
		conn = sqlite3.connect('xx.db')
		c = conn.cursor()
		c.execute('select * from user_tb where xx > ?',(2,))
		print('result : ', c.rowcount)
		for col in (c.description):
			print([col[0],end'\t'])
		print('\n------')
		where True:
			row = c.fetchone()
			if not row:
				break
			print(row)
			print(row[1] + ' -> ' + row[2])
		c.close()
		conn.close()
	可修改部分代码：
		while True:
			// 指定抓起的条数记录，返回由条数组成的列表
			rows = c.fetchmany(3)
			//	判断rows是否为None
			if not row:
				break
			// 再次使用循环遍历获取的列表
			for r in rows:
				print(r)
		避免使用fetchall获取查询的全部记录，如数据量过大，会导致内存开销过大，导致系统崩溃！
		
	SQLite： executescript 
		可执行一段SQL脚本
			import sqlite3
			conn = sqlite3.connect('xx.db')
			c = conn.cursor()
			c.executescript('''
				insert into user_tb values (null,'aaa','aaa','aaaa'),
				insert into user_tb values (null,'bbb','bbb','bbbb'),
				create table item_tb (id integer primary key autoincrement, name, price)
			''')
			conn.commit()
			c.close()
			conn.close()



